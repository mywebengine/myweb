import{incCmdName,scopeCmdName,orderCmdName,incValAttrName}from"../const.js";import{copy,normalizeURL,getURL,isURI,spaceRe}from"../../util.js";import createArrFragment from"../../arrfr.js";import pimport from"../../pimport.js";export const inc_cache=new Map;const inc_waitingStack=new Map,inc_loadEventName="inc_load",inc_mountEventName="inc_mount",inc_renderEventName="inc_render";self.isOldEdge=-1!=navigator.userAgent.search("Edge/1\\d+\\.");export default{render:function(a){const b=inc_get.call(this,a);if(!b)return{isLast:!0};const c=getIncVal(a.$src,a.str);if(c&&c==b.url)return{$e:inc_included.call(this,a,b),isLast:!0};if("complete"==b.readyState)return{$e:inc_include.call(this,a,b),isLast:!0};const d=inc_get$els.call(this,a.$src),e=d[d.length-1];return(a.scope=copy(a.scope),inc_waitingStack.has(b.url))?(inc_waitingStack.get(b.url).set(a.$src,a),{$e:e,isLast:!0}):(inc_waitingStack.set(b.url,new Map([[a.$src,a]])),fetch(b.url).then(c=>{if(c.ok)return c.text();if(a.$src.dataset.onerror){const b=this.eval({$src:a.$src,scope:copy(a.scope),expr:a.$src.dataset.onerror});if(b)return fetch(b).then(c=>c.ok?c.text():void this.check(new Error(">>>Tpl inc:render:02: Request "+b+" stat "+c.status),a))}this.check(new Error(">>>Tpl inc:render:01: Request "+b.url+" stat "+c.status),a)}).then(c=>inc_createFragment.call(this,a,b,c)).then(a=>{b.$fr=a,b.readyState="loaded";({detail:{tpl:this,include:b}});dispatchEvent(inc_loadEventName+b.url,b),dispatchEvent(inc_loadEventName,b),inc_loadInc.call(this,b)}),{$e:e,isLast:!0})},linker(a){const b=inc_get.call(this,a);if(!b)return{isLast:!0};const c=inc_get$els.call(this,a.$src),d=c.length;for(let b=0;b<d;b++){const d=c[b];d instanceof HTMLElement&&this.linker(d,a.scope,this.getAttrsAfter(this.getAttrs(d),a.str))}const e=createArrFragment(c);return dispatchMountEvent(b,e),dispatchEvent(inc_renderEventName+b.url,b,e),{$e:c[d-1],isLast:!0}}};function inc_get(a){let b=a.args[0]?a.expr:this.eval(a);if(!b)return;b=getURL(b,this.getTopURLBy$src(a.$src));let c=inc_cache.get(b);return c||inc_cache.set(b,c={readyState:"loading",url:b,descrById:new Map}),c}function inc_createFragment(a,b,c){if(self.isOldEdge)for(let a;a=/((<link\s[^\>]*?)href\=)/.exec(c);)c=c.replace(a[1],a[2]+"_ref=");const d=document.createElement("div");d.innerHTML=c,self.markLines&&self.markLines.mark({url:b.url,html:c},{children:d.children}),b.$tags=[];const e=self.isOldEdge?"_ref":"href";for(const f of d.querySelectorAll("link[rel]")){const a=f.getAttribute(e);if(a){const c=getURL(a,b.url);(self.isOldEdge||a!=c)&&f.setAttribute("href",c)}b.$tags.push(f)}b.$tags.push(...d.querySelectorAll("style"));const f=d.querySelectorAll("script");return f.length?inc_createScripts.call(this,a,b,f).then(()=>createFragmentByWrap(b,d)):createFragmentByWrap(b,d)}function inc_createScripts(a,b,c){b.$tags.push(...c);const d=[];for(const e of c)d.push(inc_createScript.call(this,a,b,e));return Promise.all(d)}function inc_createScript(a,b,c){const d=c.getAttribute("src"),e=d?getURL(d,b.url):void 0;if(e&&e!=d&&c.setAttribute("src",e),"module"==c.type){if(e)return pimport(e).catch(b=>{inc_check.call(this,b,a,c,e)});const b=URL.createObjectURL(new Blob([c.textContent],{type:"text/javascript"}));return pimport(b).catch(inc_check.bind(this,a,c)).then(()=>{this.isDebug||URL.revokeObjectURL(b)})}return e?fetch(e).then(b=>b.ok?b.text():void this.check(new Error(">>>Tpl inc:inc_createScripts:01: Request stat "+b.status),a)).then(b=>{inc_runScript.call(this,a,b,c,e)}):void inc_runScript.call(this,a,c.textContent,c,e)}function inc_runScript(a,b,c,d){try{new Function(b).call(c)}catch(b){inc_check.call(this,b,a,c,d)}}function inc_check(a,b,c,d){if(d)this.check(a,b,d,a.lineNumber,a.columnNumber);else if(c&&c.getLineNo){const d=c.getLineNo(),e=d.lastIndexOf(":");this.check(a,b,location.origin+normalizeURL(d.substr(0,e)),+d.substr(e+1)-1+a.lineNumber)}else this.check(a,b)}function createFragmentByWrap(a,b){appendHeadTags(a),joinText(b);const c=document.createDocumentFragment();for(let d;d=b.firstChild;)c.appendChild(d);return c}function appendHeadTags(a){if(a.$tags.length&&a.$tags[0].parentNode!=document.head)for(const b of a.$tags)//!! add
document.head.appendChild(b)}function joinText(a){for(let b,c=a.firstChild;c;c=c.nextSibling)for(;c instanceof Text&&(b=c.nextSibling)instanceof Text;)c.textContent+=a.removeChild(b).textContent}function inc_loadInc(a){for(const b of inc_waitingStack.get(a.url).values())b.$src.parentNode instanceof DocumentFragment||inc_include.call(this,b,a);inc_waitingStack.delete(a.url),a.readyState="complete"}function inc_include(a,b){let c=inc_get$els.call(this,a.$src),d=c.length;const e=inc_cloneFragment.call(this,a,b),f=c[0].parentNode,g=c[d-1].nextSibling;g instanceof Comment&&"inc_end"==g.textContent||(e.insertBefore(document.createComment("inc_begin"),e.firstChild),e.appendChild(document.createComment("inc_end")));const h=inc_waitingStack.get(b.url);if(h)for(let a=0;a<d;a++)h.delete(c[a]),this.removeChild(c[a]);else for(let a=0;a<d;a++)this.removeChild(c[a]);c=Array(d=e.childNodes.length);for(let f=0;f<d;f++)c[f]=e.childNodes[f];f.insertBefore(e,g);let i=c[0];for(;i;){i instanceof HTMLElement?i=this.renderTag(i,a.scope,this.getAttrsAfter(this.getAttrs(i),a.str)):i instanceof Text&&(i=this.renderText(i,a.scope));const b=i.nextSibling;if(!b||b==g)break;i=b}const j=createArrFragment(c);return dispatchMountEvent(b,j),dispatchEvent(inc_renderEventName+b.url,b,j),i}function inc_included(a,b){const c=inc_get$els.call(this,a.$src),d=c.length,e=c[d-1].nextSibling;let f=c[0];for(;f;){f instanceof HTMLElement&&(f=this.renderTag(f,a.scope,this.getAttrsAfter(this.getAttrs(f),a.str)));const b=f.nextSibling;if(!b||b==e)break;f=b}const g=createArrFragment(c);return a.$src.inc_isMounted||dispatchMountEvent(b,g),dispatchEvent(inc_renderEventName+b.url,b,g),f}export function inc_get$els(a){this.get$srcDescr(a);if(!inc_isRenderdInc.call(this,a))return[a];const b=[];for(let c=a;c&&(b.push(c),!(c instanceof Comment&&"inc_begin"==c.textContent));c=c.previousSibling);b.reverse();for(let c=a.nextSibling;c&&(b.push(c),!(c instanceof Comment&&"inc_end"==c.textContent));c=c.nextSibling);return b}export function inc_isInc(a,b){const c=this.getAttrs(a);let d;for(const e of c.keys()){if(!d&&b){e==b&&(d=!0);continue}const[a]=this.getCmdArgs(e);if(a==incCmdName)return!0}}export function inc_isRenderdInc(a){const b=this.getAttrs(a);for(const c of b.keys()){const[a]=this.getCmdArgs(c);if(a==incCmdName&&b.has(getIncValName(c)))return!0}}function inc_cloneFragment(b,c){const e=c.$fr.cloneNode(!0);inc_isRenderdInc.call(this,b.$src)||makeSlots(b,e);const f=this.get$srcDescr(b.$src);let a=c.descrById.get(f.id);a||c.descrById.set(f.id,a=[]);const d=f.attr,g=d.get(orderCmdName)||Array.from(d.keys()).join(" "),h=d.get(scopeCmdName)||"";for(let d,j,k=e.firstElementChild,l=0;k;k=k.nextElementSibling,l++){if(d=k.getAttribute(orderCmdName))d=g+" "+d;else{d=g;const a=Array.from(k.attributes),b=a.length;for(let c=0;c<b;c++)d+=" "+a[c].name}(d=d.trim())&&k.setAttribute(orderCmdName,Array.from(new Set(d.split(spaceRe))).join(" ")),j=(j=k.getAttribute(scopeCmdName))?h+" "+j:h,(j=j.trim())&&k.setAttribute(scopeCmdName,Array.from(new Set(j.split(spaceRe))).join(" "));for(const c of Array.from(b.$src.attributes))k.getAttribute(c.name)||k.setAttribute(c.name,c.value);k.setAttribute(getIncValName(b.str),c.url),a[l]||(a[l]=this.createTagDescr(k));const e=a[l];//!!for
this.setDescrWithVars(f,k,e.id),e.for_oldLastVal=f.for_oldLastVal}return e}function makeSlots(a,b){const c=b.querySelectorAll("slot[name]"),d=c.length,e=b.firstElementChild||b;if(!d){for(let b=a.$src;b=a.$src.firstChild;)e.appendChild(b);return}//!!for Edge
for(let e=0;e<d;e++){const a=c[e];a.name||(a.name=a.getAttribute("name"))}for(let f=a.$src;f=a.$src.firstChild;){if(f instanceof HTMLElement){//!!for Edge
if(!f.slot){const a=f.getAttribute("slot");a&&(f.slot=a)}if(f.slot){let a;for(let b=0;b<d;b++){const d=c[b];if(f.slot==d.name){d.appendChild(f),a=!0;break}}if(a)continue}}e.appendChild(f)}}function dispatchEvent(a,b,c){const d={detail:{tpl:this,include:b,$body:c}};self.dispatchEvent(new CustomEvent(a,d))}function dispatchMountEvent(a,b){dispatchEvent(inc_mountEventName+a.url,a,b),dispatchEvent(inc_mountEventName,a,b);const c=b.firstElementChild;c&&(c.inc_isMounted=!0)}function getIncValName(a){return incValAttrName+"_"+a}export function getIncVal(a,b){return a.getAttribute(getIncValName(b))}export function getIncEventName(a,b){return{inc_load:inc_loadEventName+getURL(a,b),inc_mount:inc_mountEventName+getURL(a,b),inc_render:inc_renderEventName+getURL(a,b)}}