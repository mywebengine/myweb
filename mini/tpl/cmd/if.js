import{ifCmdName,elseifCmdName,elseCmdName,switchCmdName,caseCmdName,defaultCmdName}from"../const.js";import{copy}from"../../util.js";import{inc_isInc,inc_get$els}from"./inc.js";export const ifCmd={render(a){return if_get.call(this,a,this.renderTag.bind(this),this.show.bind(this),this.hide.bind(this),a=>a,ifCmdName,elseifCmdName,elseCmdName)},linker(a){return if_get.call(this,a,this.linker.bind(this),a=>a,a=>a,ifCmdName,elseifCmdName,elseCmdName)},getScope:if_getScope};export const switchCmd={render(a){return switch_get.call(this,a,this.renderTag.bind(this))},linker(a){return switch_get.call(this,a,this.linker.bind(this))},getScope:if_getScope};function if_getScope(a){if(a.cmdName==elseCmdName)return!0;const b=a.args[0],c=this.eval(a);return b&&(a.scope[b]=c),!!c}function if_get(a,b,c,d,e=a=>a,f,g,h,i){i||(i=if_make$first.call(this,a,f,g,h));let j;(a.value=e(this.eval(a)))?[i,j]=if_render.call(this,a,c(i,a.str),b):(i=d(i,a.str),j=!0);for(const k of this.getAttrs(i instanceof HTMLElement?i:i.previousElementSibling).keys()){if(k==a.str)break;const[b]=this.getCmdArgs(k);if(b==f&&f!=switchCmdName||b==g||b==h)return{$e:i,isLast:j}}for(let k=i.nextElementSibling;k;k=k.nextElementSibling){let l;for(const[m,n]of this.getAttrs(k)){const[o,p]=this.getCmdArgs(m);if(o==f){l=!0;break}if(l=o==h,l||o==g){if(a.value){[k,i]=if_apply.call(this,k,m,b=>d(b,a.str)),j=!0;break}a.cmdName=o,a.str=m,a.expr=n,a.args=p,a.$src=k,l||(a.value=e(this.eval(a)))?([k,i]=if_apply.call(this,k,m,b=>c(b,a.str)),[k,j]=if_render.call(this,a,k,b)):([k,i]=if_apply.call(this,k,m,b=>d(b,a.str)),j=!0);break}}if(l)break}return{$e:i,isLast:j}}function if_make$first(a,b,c){if(a.cmdName==b)return a.$src;for(let d=a.$src.previousElementSibling;d;d=d.previousElementSibling){let e;for(const[f,g]of this.getAttrs(d)){const[h,i]=this.getCmdArgs(f);if(h==c){e=!0;break}if(h==b)return a.cmdName=h,a.str=f,a.expr=g,a.args=i,d}if(!e)return a.$srcForErr=d,void this.check(new Error(">>>Tpl if:01:Invalid structure: if or elseif-comand not found"),a)}this.check(new Error(">>>Tpl if:02:Invalid structure: if-command not found"),a)}function if_render(a,b,c){const d=a.args[0],e=copy(a.scope);return d&&(e[d]=a.value),[c(b,e,this.getAttrsAfter(this.getAttrs(b),a.str)),!0]}function if_apply(a,b,c){if(!inc_isInc.call(this,a,b))return a=c(a),[a,a];const d=inc_get$els.call(this,a),e=d.length;for(let f=0;f<e;f++)d[f]instanceof Comment||(a=d[f]=c(d[f]));return[a,d[e-1]]}function switch_get(a,b){const c=if_make$first.call(this,a,switchCmdName,caseCmdName,defaultCmdName);let d;for(const[e,f]of this.getAttrs(c)){if(!d){e==a.str&&(d=!0);continue}const[g,h]=this.getCmdArgs(e);if(g==caseCmdName){const d=this.eval(a);return a.str=e,a.expr=f,a.args=h,if_get.call(this,a,b,this.show.bind(this),this.hide.bind(this),a=>a==d,switchCmdName,caseCmdName,defaultCmdName,c)}}this.check(new Error(">>>Tpl switch:01:Invalide structure: case-cmmand not found"),a)}